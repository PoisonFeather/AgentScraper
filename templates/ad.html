{% extends "base.html" %}
{% block content %}

<style>
  /* --- ad detail tweaks (safe to inline; you can move to your main css) --- */
  .ad-hero {
    background: #f8f9fa;
    border: 1px solid rgba(0,0,0,.06);
  }
  .ad-hero img {
    width: 100%;
    height: 420px;          /* <= cap image height */
    object-fit: contain;    /* keep full image without cropping */
    background: #fff;
  }
  @media (max-width: 768px) {
    .ad-hero img { height: 300px; }
  }

  .kv-table td { padding: .35rem .5rem; }
  .kv-key { width: 38%; white-space: nowrap; color: #6c757d; }

  .sticky-col {
    position: sticky;
    top: 16px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .25rem .55rem;
    border-radius: 999px;
    font-size: .85rem;
    background: rgba(0,0,0,.04);
  }

  .mono-box {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    white-space: pre-wrap;
    word-break: break-word;
    background: #fff;
    border: 1px solid rgba(0,0,0,.06);
  }

  .section-title {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: .75rem;
  }

  .signal-list li { margin-bottom: .25rem; }
</style>

{% if not ad %}
  <div class="alert alert-warning d-flex align-items-center justify-content-between">
    <div>Anunț inexistent.</div>
    <a class="btn btn-outline-dark btn-sm" href="{{ url_for('index') if url_for else '/' }}">Înapoi</a>
  </div>
{% else %}

  <!-- TOP SUMMARY BAR -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h4 class="mb-1">{{ ad.title }}</h4>
      <div class="text-muted small">
        {{ ad.location_text or "—" }}
        {% if ad.distance_km is not none %}
          • {{ "%.1f"|format(ad.distance_km) }} km de Cluj
        {% endif %}
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="chip"><strong>Score</strong> {{ "%.1f"|format(ad.score or 0) }}</span>
      <span class="chip"><strong>Preț</strong> {{ ad.price_ron or "?" }} RON</span>
      {% if ad.confidence is not none %}
        <span class="chip"><strong>Conf.</strong> {{ ad.confidence }}</span>
      {% endif %}
      <a class="btn btn-dark" href="{{ ad.url }}" target="_blank" rel="noreferrer">Deschide OLX</a>
    </div>
  </div>

  <div class="row g-3">
    <!-- LEFT: IMAGES + DESCRIPTION -->
    <div class="col-lg-7">
      <div class="card ad-hero shadow-sm">
        <div class="card-body p-2">
          {% if ad.image_url %}
            <img src="{{ ad.image_url }}" class="rounded" alt="img">
          {% else %}
            <div class="p-4 text-center text-muted">Fără imagine.</div>
          {% endif %}
        </div>
      </div>

      <!-- QUICK FACTS (you can add more fields if you have them) -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-title mb-2">
            <h6 class="mb-0">Rezumat rapid</h6>
            <span class="badge bg-light text-dark border">{{ ad.verdict }}</span>
          </div>

          <table class="table table-sm mb-0 kv-table">
            <tbody>
              <tr>
                <td class="kv-key">Piese suspecte</td>
                <td>{{ ad.parts_suspected or "—" }}</td>
              </tr>
              <tr>
                <td class="kv-key">Reparații estimate</td>
                <td>{{ ad.repair_estimate_low }}–{{ ad.repair_estimate_high }} RON</td>
              </tr>
              {% if ad.resale_value_low is not none or ad.resale_value_high is not none %}
              <tr>
                <td class="kv-key">Resale estimat</td>
                <td>{{ ad.resale_value_low }}–{{ ad.resale_value_high }} RON</td>
              </tr>
              {% endif %}
              {% if ad.profit_low is not none or ad.profit_high is not none %}
              <tr>
                <td class="kv-key">Profit estimat</td>
                <td>{{ ad.profit_low }}–{{ ad.profit_high }} RON</td>
              </tr>
              {% endif %}
            </tbody>
          </table>

          {% if ad.reasoning %}
            <hr class="my-3">
            <p class="mb-0">{{ ad.reasoning }}</p>
          {% endif %}
        </div>
      </div>

      <!-- DESCRIPTION -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h6 class="mb-2">Descriere</h6>
          <div class="p-3 rounded mono-box">{{ ad.description or "" }}</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: STICKY DIAGNOSTIC -->
    <div class="col-lg-5">
      <div class="sticky-col">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="section-title mb-2">
              <h6 class="mb-0">Diagnostic</h6>
              <span class="badge bg-dark">score {{ "%.1f"|format(ad.score or 0) }}</span>
            </div>

            {% if ad.notes %}
              <div class="small text-muted mb-2">
                {% if ad.confidence is not none %}Confidence: {{ ad.confidence }}{% endif %}
              </div>
              <p class="mb-0">{{ ad.notes }}</p>
            {% else %}
              <div class="text-muted">—</div>
            {% endif %}

            <hr class="my-3">

            <!-- Collapsible details (Bootstrap) -->
            <div class="accordion" id="diagAccordion">

              <div class="accordion-item">
                <h2 class="accordion-header" id="headSignals">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSignals" aria-expanded="true" aria-controls="collapseSignals">
                    Semnale
                  </button>
                </h2>
                <div id="collapseSignals" class="accordion-collapse collapse show" aria-labelledby="headSignals" data-bs-parent="#diagAccordion">
                  <div class="accordion-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="fw-semibold mb-1">Pozitive</div>
                        <ul class="signal-list mb-0">
                          {% for s in ad.signals_positive or [] %}
                            <li>{{ s }}</li>
                          {% else %}
                            <li class="text-muted">—</li>
                          {% endfor %}
                        </ul>
                      </div>
                      <div class="col-md-6 mt-3 mt-md-0">
                        <div class="fw-semibold mb-1">Negative</div>
                        {% if ad.signals_negative %}
                          {# if it's a list, render list; if it's text, show as box #}
                          {% if ad.signals_negative is sequence and ad.signals_negative is not string %}
                            <ul class="signal-list mb-0">
                              {% for s in ad.signals_negative %}
                                <li>{{ s }}</li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <div class="p-2 rounded mono-box">{{ ad.signals_negative }}</div>
                          {% endif %}
                        {% else %}
                          <div class="text-muted">—</div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="accordion-item">
                <h2 class="accordion-header" id="headTests">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTests" aria-expanded="false" aria-controls="collapseTests">
                    Plan rapid de test
                  </button>
                </h2>
                <div id="collapseTests" class="accordion-collapse collapse" aria-labelledby="headTests" data-bs-parent="#diagAccordion">
                  <div class="accordion-body">
                    <div class="p-2 rounded mono-box">{{ ad.quick_tests or "—" }}</div>
                  </div>
                </div>
              </div>

              <div class="accordion-item">
                <h2 class="accordion-header" id="headCosts">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCosts" aria-expanded="false" aria-controls="collapseCosts">
                    Cost breakdown
                  </button>
                </h2>
                <div id="collapseCosts" class="accordion-collapse collapse" aria-labelledby="headCosts" data-bs-parent="#diagAccordion">
                  <div class="accordion-body">
                    <div class="p-2 rounded mono-box">{{ ad.repair_items or "—" }}</div>
                  </div>
                </div>
              </div>

            </div>

            <hr class="my-3">

            <div class="d-grid gap-2">
              <a class="btn btn-dark" href="{{ ad.url }}" target="_blank" rel="noreferrer">Deschide OLX</a>
              <a class="btn btn-outline-secondary" href="{{ url_for('index') if url_for else '/' }}">Înapoi la listă</a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endif %}

{% endblock %}